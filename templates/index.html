<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Demo</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:       #0d0f14;
      --surface:  #161922;
      --surface2: #1e2230;
      --border:   #2a2f42;
      --accent:   #4f8ef7;
      --accent2:  #f7884f;
      --ok:       #3ecf74;
      --err:      #e05c5c;
      --text:     #dde2f0;
      --muted:    #6b738f;
      --mono:     'Space Mono', monospace;
      --sans:     'DM Sans', sans-serif;
      --radius:   0px;
      --shadow:   0 4px 32px rgba(0,0,0,.45);
    }
    body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; line-height: 1.6; }

    main { max-width: 1200px; margin: 0 auto; padding: 2.5rem 1.5rem 4rem; }

    .upload-card {
      background: var(--surface); border: 1px solid var(--border);
      padding: 2rem 2.5rem; margin-bottom: 2rem; box-shadow: var(--shadow);
    }
    .add-files-btn {
      font-family: var(--mono); font-size: .8rem; font-weight: 700;
      background: transparent; color: var(--accent);
      border: 1px solid var(--accent); padding: .45rem 1rem;
      cursor: pointer; position: relative; transition: background .15s;
      display: inline-block;
    }
    .add-files-btn:hover { background: rgba(79,142,247,.08); }
    .add-files-btn input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }

    #file-list { display: flex; flex-wrap: wrap; gap: .5rem; margin-top: 1rem; }
    .file-chip {
      display: flex; align-items: center; gap: .4rem;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 100px; padding: .3rem .75rem;
      font-size: .78rem; font-family: var(--mono);
    }
    .file-chip .rm { cursor: pointer; color: var(--muted); font-size: 1rem; }
    .file-chip .rm:hover { color: var(--err); }

    .form-footer { display: flex; justify-content: flex-end; margin-top: 1.4rem; }
    .submit-btn {
      font-family: var(--mono); font-size: .85rem; font-weight: 700;
      background: var(--accent); color: #fff; border: none;
      padding: .65rem 1.6rem; cursor: pointer; letter-spacing: .03em;
      transition: background .15s, transform .1s;
      display: flex; align-items: center; gap: .5rem;
    }
    .submit-btn:hover { background: #3a7be0; }
    .submit-btn:disabled { opacity: .4; cursor: not-allowed; }

    .workspace {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 1.5rem;
      align-items: start;
    }

    .selector-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 1rem;
      position: sticky;
      top: 1.5rem;
    }

    .selector-group { display: flex; flex-direction: column; gap: .4rem; }

    .selector-divider {
      font-family: var(--mono); font-size: .68rem; font-weight: 700;
      color: var(--muted); letter-spacing: .1em; text-transform: uppercase;
      padding: .75rem 0 .4rem;
      border-top: 1px solid var(--border);
      margin-top: .5rem;
    }

    .selector-btn {
      width: 100%; text-align: left;
      font-family: var(--mono); font-size: .78rem;
      background: transparent; color: var(--text);
      border: 1px solid transparent;
      padding: .45rem .7rem; cursor: pointer;
      transition: background .15s, border-color .15s, color .15s;
    }
    .selector-btn:hover { background: var(--surface2); border-color: var(--border); }
    .selector-btn.active { background: rgba(79,142,247,.12); border-color: var(--accent); color: var(--accent); }

    .team-btn { color: var(--accent2); font-weight: 700; }
    .team-btn:hover { border-color: var(--accent2) !important; }
    .team-btn.active { background: rgba(247,136,79,.12) !important; border-color: var(--accent2) !important; color: var(--accent2) !important; }

    #chart-area { min-height: 200px; }
    .chart-area-header {
      display: flex; align-items: center; gap: .75rem;
      margin-bottom: 1rem;
      padding-bottom: .75rem;
      border-bottom: 1px solid var(--border);
    }
    .chart-area-title { font-family: var(--mono); font-size: 1rem; font-weight: 700; color: var(--text); }
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
    }

    .error-msg { padding: 1.2rem; font-family: var(--mono); font-size: .75rem; color: var(--err); white-space: pre-wrap; }

    ::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
<main>
    <div class="upload-card">
      <form id="upload-form"
            hx-post="/upload"
            hx-target="#workspace"
            hx-swap="innerHTML"
            hx-encoding="multipart/form-data">
        <label class="add-files-btn">
          + Add Files
          <input type="file" name="files" id="file-input"
                 multiple accept=".csv"
                 onchange="updateFileList(this.files)" />
        </label>
        <div id="file-list"></div>
      </form>
    </div>
    <div class="workspace" id="workspace"></div>
</main>

<script>
  let selectedSessionId = null;
  let selectedPlayer = null;

  function selectPlayer(btn, sessionId, player) {
    selectedSessionId = sessionId;
    selectedPlayer = player;
    document.querySelectorAll('.selector-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadCharts();
  }

  function loadCharts() {
    if (!selectedSessionId || !selectedPlayer) return;
    const url = `/charts/${selectedSessionId}/${encodeURIComponent(selectedPlayer)}`;
    htmx.ajax('GET', url, { target: '#chart-area', swap: 'innerHTML' });
  }

  let selectedFiles = new DataTransfer();

    function updateFileList(files) {
      for (const f of files) {
        let dup = false;
        for (const e of selectedFiles.files) {
          if (e.name === f.name && e.size === f.size) { dup = true; break; }
        }
        if (!dup) selectedFiles.items.add(f);
      }
      syncInput();
      renderChips();
      // auto-submit as soon as files are added
      if (selectedFiles.files.length > 0) {
        document.getElementById('upload-form').requestSubmit();
      }
    }

  function removeFile(name) {
    const next = new DataTransfer();
    for (const f of selectedFiles.files) { if (f.name !== name) next.items.add(f); }
    selectedFiles = next;
    syncInput(); renderChips();
  }

  function syncInput() {
    document.getElementById('file-input').files = selectedFiles.files;
  }

  function renderChips() {
    const list = document.getElementById('file-list');
    list.innerHTML = '';
    for (const f of selectedFiles.files) {
      const chip = document.createElement('div');
      chip.className = 'file-chip';
      chip.innerHTML = `<span>ðŸ“„</span><span>${f.name}</span><span class="rm" onclick="removeFile('${f.name}')" title="Remove">Ã—</span>`;
      list.appendChild(chip);
    }
  }

  document.body.addEventListener('htmx:beforeRequest', e => {
    const trigger = e.detail.elt;
    if (trigger && trigger.classList.contains('selector-btn')) {
      document.querySelectorAll('.selector-btn').forEach(b => b.classList.remove('active'));
      trigger.classList.add('active');
    }
  });

</script>
</body>
</html>
